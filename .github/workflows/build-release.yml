name: Build Release

on:
  push:
    tags:
      - 'v*'

env:
  BUILD_TYPE: Release
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    # è®¾ç½® MSBuild çŽ¯å¢ƒ
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    # è®¾ç½® vcpkg ç¼“å­˜
    - name: Setup vcpkg cache
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
    
    # å®‰è£…å¹¶é…ç½® vcpkg
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: 'b1e15efef6758eaa0beb0a8732cfa66f6a68a81d'
        vcpkgJsonGlob: 'vcpkg.json'
    
    # å®‰è£…ä¾èµ–åŒ…
    - name: Install dependencies via vcpkg
      run: |
        echo "æ­£åœ¨å®‰è£… vcpkg ä¾èµ–åŒ…..."
        
        # å®‰è£…æ ¸å¿ƒä¾èµ–
        .\vcpkg\vcpkg.exe install cpr:x64-windows
        .\vcpkg\vcpkg.exe install gumbo-parser:x64-windows
        .\vcpkg\vcpkg.exe install nlohmann-json:x64-windows
        
        # å®‰è£… OpenCV (é‡ç‚¹é…ç½®)
        .\vcpkg\vcpkg.exe install opencv4[core,imgproc,imgcodecs]:x64-windows
        
        # å®‰è£… ONNX Runtime
        .\vcpkg\vcpkg.exe install onnxruntime:x64-windows
        
        # å®‰è£… Crypto++ 
        .\vcpkg\vcpkg.exe install cryptopp:x64-windows
        
        # æ˜¾ç¤ºå®‰è£…çŠ¶æ€
        .\vcpkg\vcpkg.exe list
      shell: cmd
    
    - name: Download ONNX model
      run: |
        if (!(Test-Path "Marduk\crnn_model.onnx")) {
          Write-Host "è­¦å‘Š: ONNX æ¨¡åž‹æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²åŒ…å«åœ¨ä»“åº“ä¸­"
        } else {
          Write-Host "ONNX æ¨¡åž‹æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        }
      shell: powershell
    
    # ç¼–è¯‘é¡¹ç›®
    - name: Build project
      run: |
        echo "å¼€å§‹ç¼–è¯‘é¡¹ç›®..."
        
        # è®¾ç½® vcpkg å·¥å…·é“¾è·¯å¾„
        set VCPKG_ROOT=${{ github.workspace }}\vcpkg
        set CMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake
        
        # ä½¿ç”¨ MSBuild ç¼–è¯‘è§£å†³æ–¹æ¡ˆ
        msbuild Marduk.sln ^
          /p:Configuration=Release ^
          /p:Platform=x64 ^
          /p:VcpkgTriplet=x64-windows ^
          /p:VcpkgRoot=${{ github.workspace }}\vcpkg ^
          /verbosity:minimal ^
          /maxcpucount
        
        echo "ç¼–è¯‘å®Œæˆï¼"
      shell: cmd
    
    # æ£€æŸ¥ç¼–è¯‘è¾“å‡º
    - name: Verify build outputs
      run: |
        $OutputDir = "bin\x64\Release"
        
        Write-Host "æ£€æŸ¥ç¼–è¯‘è¾“å‡º..."
        if (Test-Path $OutputDir) {
          Get-ChildItem $OutputDir -Recurse | ForEach-Object {
            Write-Host "  âœ“ $($_.Name) ($($_.Length) bytes)"
          }
        } else {
          Write-Error "ç¼–è¯‘è¾“å‡ºç›®å½•ä¸å­˜åœ¨: $OutputDir"
          exit 1
        }
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        $RequiredFiles = @(
          "$OutputDir\Marduk.exe",
          "$OutputDir\ZfwInteractionDll.dll", 
          "$OutputDir\DNSManagerDll.dll",
          "$OutputDir\NetworkDiagnosticDll.dll"
        )
        
        foreach ($file in $RequiredFiles) {
          if (!(Test-Path $file)) {
            Write-Error "ç¼ºå°‘å…³é”®æ–‡ä»¶: $file"
            exit 1
          }
        }
        
        Write-Host "æ‰€æœ‰å…³é”®æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
      shell: powershell
    
    # æ”¶é›†è¿è¡Œæ—¶ä¾èµ–
    - name: Collect runtime dependencies
      run: |
        $OutputDir = "bin\x64\Release"
        $VcpkgBinDir = "vcpkg\installed\x64-windows\bin"
        
        Write-Host "æ”¶é›†è¿è¡Œæ—¶ä¾èµ–åº“..."
        
        # å¤åˆ¶ vcpkg å®‰è£…çš„ DLL
        if (Test-Path $VcpkgBinDir) {
          $DllFiles = Get-ChildItem "$VcpkgBinDir\*.dll"
          foreach ($dll in $DllFiles) {
            Copy-Item $dll.FullName -Destination $OutputDir -Force
            Write-Host "  âœ“ å¤åˆ¶: $($dll.Name)"
          }
        }
        
        Write-Host "ä¾èµ–æ”¶é›†å®Œæˆï¼"
      shell: powershell
    
    # åˆ›å»ºå‘å¸ƒåŒ…
    - name: Create release package
      run: |
        $Version = "${{ github.ref_name }}"
        $PackageName = "Marduk-$Version-Windows-x64"
        $SourceDir = "bin\x64\Release"
        $PackageDir = $PackageName
        
        Write-Host "åˆ›å»ºå‘å¸ƒåŒ…: $PackageName"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Path $PackageDir -Force
        
        # å¤åˆ¶ç¨‹åºæ–‡ä»¶
        Copy-Item "$SourceDir\*" -Destination $PackageDir -Recurse -Force
        
        # å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
        Copy-Item "README.md" -Destination "$PackageDir\README.md" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination "$PackageDir\LICENSE.txt" -ErrorAction SilentlyContinue
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        @"
          Marduk - è¥¿ç”µæ ¡å›­ç½‘ç»œè¯Šæ–­å·¥å…·
          ç‰ˆæœ¬: $Version
          ç¼–è¯‘æ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          ç¼–è¯‘çŽ¯å¢ƒ: GitHub Actions (Windows 2022)
          æž¶æž„: x64

          ä½¿ç”¨è¯´æ˜Ž:
          1. ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ Marduk.exe
          2. è¾“å…¥ 'help' æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
          3. å»ºè®®é¦–æ¬¡ä½¿ç”¨æ‰§è¡Œ: login -> diagno -> pasopt

          æŠ€æœ¯æ”¯æŒ: NCC (ç½‘ç»œå®‰å…¨åä¼š)
          "@ | Out-File -FilePath "$PackageDir\VERSION.txt" -Encoding UTF8
        
        # åˆ›å»º ZIP åŽ‹ç¼©åŒ…
        Compress-Archive -Path $PackageDir -DestinationPath "$PackageName.zip" -Force
        
        Write-Host "å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ: $PackageName.zip"
        
        # è¾“å‡ºåˆ°çŽ¯å¢ƒå˜é‡ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        "PACKAGE_NAME=$PackageName" | Out-File -FilePath $env:GITHUB_ENV -Append
        "PACKAGE_FILE=$PackageName.zip" | Out-File -FilePath $env:GITHUB_ENV -Append
      shell: powershell
    
    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: ${{ env.PACKAGE_FILE }}
        retention-days: 90
    
    # åˆ›å»º GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Marduk ${{ github.ref_name }}"
        body: |
          # Marduk ${{ github.ref_name }} - è¥¿ç”µæ ¡å›­ç½‘ç»œè¯Šæ–­å·¥å…·
          
          ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **å‘å¸ƒæ—¶é—´**: ${{ steps.date.outputs.date }}
          **ç¼–è¯‘çŽ¯å¢ƒ**: GitHub Actions (Windows 2022 + MSVC)
          **æž¶æž„æ”¯æŒ**: Windows x64
          
          ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          - **å®Œæ•´ç‰ˆ**: `Marduk-${{ github.ref_name }}-Windows-x64.zip` (æŽ¨è)
            - åŒ…å«æ‰€æœ‰è¿è¡Œæ—¶ä¾èµ–
            - è§£åŽ‹å³ç”¨ï¼Œæ— éœ€é¢å¤–å®‰è£…
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¹¶è§£åŽ‹ `Marduk-${{ github.ref_name }}-Windows-x64.zip`
          2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ `Marduk.exe`
          3. è¾“å…¥ `help` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
          4. å»ºè®®æ–°ç”¨æˆ·æ‰§è¡Œï¼š`login` â†’ `diagno` â†’ `pasopt`
          
          ## âš ï¸ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10/11 (x64)
          - Microsoft Visual C++ 2019/2022 Redistributable
          - ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äºŽDNSæœåŠ¡ç®¡ç†ï¼‰
          
          ## ðŸ”§ æŠ€æœ¯ä¿¡æ¯
          
          - **C++ æ ‡å‡†**: C++17/20
          - **ç¼–è¯‘å™¨**: MSVC v143
          - **åŒ…ç®¡ç†**: vcpkg
          - **ä¾èµ–åº“**: OpenCV, ONNX Runtime, CPR, Crypto++
          
          ---
          
          **ç”± NCC å¼€å‘ç»´æŠ¤**
          
        files: ${{ env.PACKAGE_FILE }}
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # èŽ·å–å½“å‰æ—¥æœŸï¼ˆç”¨äºŽ Release æè¿°ï¼‰
    - name: Get current date
      id: date
      run: echo "date=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_OUTPUT
      shell: powershell